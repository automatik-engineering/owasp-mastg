rules:
  - id: mastg-android-biometric-device-credential-fallback
    languages:
      - java
    severity: WARNING
    metadata:
      summary: This rule detects BiometricPrompt configurations that allow fallback to device credentials for the android.hardware.biometrics and androidx.biometric class.
    message: "[MASVS-AUTH-3] BiometricPrompt allows fallback to device credentials. For sensitive operations, consider using BIOMETRIC_STRONG only."
    pattern-either:
    # decompiled code contains integer values instead of the constants for biometric authentication:
    #  BIOMETRIC_STRONG = 15 (0x000F)
    #  BIOMETRIC_WEAK = 255 (0x00FF)
    #  DEVICE_CREDENTIAL = 32768 (0x8000)

      # this pattern matches for the usage of setAllowedAuthenticators() in the android.hardware.biometrics class - see https://developer.android.com/reference/android/hardware/biometrics/BiometricPrompt.Builder#setAllowedAuthenticators(int)
      - patterns:
          - pattern: $BUILDER.setAllowedAuthenticators($VALUE)
          - metavariable-pattern:
              metavariable: $VALUE
              patterns:
                - pattern-not: BiometricManager.Authenticators.BIOMETRIC_STRONG
                - pattern-not: 15

      # this pattern matches for the usage of canAuthenticate() in the androidx Biometric class - see https://developer.android.com/reference/androidx/biometric/BiometricManager#canAuthenticate(int)
      - patterns: 
          - pattern: $BM.canAuthenticate($VALUE)
          - metavariable-pattern:
              metavariable: $VALUE
              patterns:
                - pattern-not: BiometricManager.Authenticators.BIOMETRIC_STRONG
                - pattern-not: 15
      - pattern: |
          $BUILDER.setDeviceCredentialAllowed(true)
