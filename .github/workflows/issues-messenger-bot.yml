name: Issue Assignment Bot Manual Helper

on:
  workflow_dispatch:
    inputs:
      issue_or_pr_number:
        description: Issue or PR number
        required: true
        type: string
      message:
        description: Message to post
        required: true
        type: choice
        options:
          - guidelines-ask
          - guidelines-confirm
      commenter:
        description: Github username to mention, without the at sign
        required: true
        type: string

permissions:
  issues: write
  contents: read

jobs:
  post_message:
    runs-on: ubuntu-latest

    steps:
      - name: Post message
        uses: actions/github-script@v7
        with:
          script: |
            const inputs = context.payload.inputs || {}
            console.log("received_inputs", inputs)

            const numberRaw =
              inputs.issue_or_pr_number ||
              core.getInput("issue_or_pr_number")

            const messageKey =
              inputs.message ||
              core.getInput("message")

            const commenterRaw =
              inputs.commenter ||
              core.getInput("commenter")

            const commenter = String(commenterRaw || "").trim()

            if (!numberRaw) {
              core.setFailed("missing input number, check received_inputs in logs for the actual key name")
              return
            }
            if (!messageKey) {
              core.setFailed("missing input message")
              return
            }
            if (!commenter) {
              core.setFailed("missing input commenter")
              return
            }

            const issueNumber = Number.parseInt(String(numberRaw), 10)
            if (!Number.isFinite(issueNumber)) {
              core.setFailed("issue or pr number must be an integer")
              return
            }

            console.log("manual_start")
            console.log("issue_number", issueNumber)
            console.log("message_key", messageKey)
            console.log("commenter", commenter)
            console.log("repo", context.repo)

            const repo = context.repo

            const repoInfo = await github.rest.repos.get({
              owner: repo.owner,
              repo: repo.repo,
            })

            const defaultBranch = repoInfo.data.default_branch || "main"
            console.log("default_branch", defaultBranch)

            const templateUrl =
              "https://github.com/" +
              repo.owner +
              "/" +
              repo.repo +
              "/blob/" +
              defaultBranch +
              "/.github/PULL_REQUEST_TEMPLATE.md"

            let body = ""

            if (messageKey === "guidelines-ask") {
              body = [
                "Hi @" + commenter + ", thanks for your interest in contributing to OWASP MASTG.",
                "",
                "Before we can assign you to this issue, please confirm that you have read and understand our contribution guidelines.",
                "",
                "See <" + templateUrl + "> and all linked documents.",
                "",
                "To confirm, please reply with the following message, copy paste it exactly.",
                "",
                "```",
                "I have read the contribution guidelines and the PR template and I confirm that I will follow them.",
                "```",
              ].join("\n")
            }

            if (messageKey === "guidelines-confirm") {
              body = [
                "Thank you @" + commenter + " for accepting the contribution guidelines.",
                "",
                "Your assignment request has been noted and labeled, a maintainer will review and assign you to this issue shortly, please refrain from making a pull request until you have been officially assigned.",
              ].join("\n")
            }

            if (!body) {
              core.setFailed("unknown message value")
              return
            }

            console.log("posting_comment")
            const res = await github.rest.issues.createComment({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: issueNumber,
              body,
            })

            console.log("comment_created_url", res.data?.html_url)

            if (messageKey === "guidelines-confirm") {
              console.log("adding_label_request_issue_assignment")
              await github.rest.issues.addLabels({
                owner: repo.owner,
                repo: repo.repo,
                issue_number: issueNumber,
                labels: ["request-issue-assignment"],
              })
            }

            console.log("manual_done")
